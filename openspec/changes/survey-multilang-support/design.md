## Context

Платформа Mapsurvey позволяет создавать опросы с гео-компонентами. Сейчас весь контент опроса хранится в одном языковом варианте непосредственно в моделях `SurveySection`, `Question`, `OptionChoice`. Существующая система i18n (спецификация `ui-internationalization`) локализует только интерфейс приложения (кнопки, навигацию), но не контент опросов.

Ключевые точки интеграции:
- `survey_header` view — точка входа в опрос, создаёт сессию
- `survey_section` view — отображает секцию, использует `SurveySectionAnswerForm`
- `SurveySectionAnswerForm` — динамически строит форму из `Question.name`, `Question.subtext`, `OptionChoice.name`

## Goals / Non-Goals

**Goals:**
- Хранить переводы контента отдельно от основных моделей (не дублировать поля)
- Экран выбора языка как первый шаг для мультиязычных опросов
- Автоматическое переключение языка интерфейса Django при выборе языка в опросе
- Обратная совместимость: опросы без переводов работают как раньше
- Управление переводами через Django admin
- Сохранение и восстановление переводов при экспорте/импорте опросов

**Non-Goals:**
- Поддержка RTL-языков (арабский, иврит) — отложено
- Вертикальные языки (китайский, японский) — отложено
- Автоматический перевод контента
- Версионирование переводов

## Decisions

### Decision 1: Отдельные модели для переводов (Translation Tables Pattern)

**Выбор:** Создать отдельные модели `SurveySectionTranslation`, `QuestionTranslation`, `OptionChoiceTranslation`, связанные FK с оригинальными сущностями.

**Альтернативы:**
- **django-modeltranslation** — добавляет поля `name_en`, `name_ru` в существующие модели. Отклонено: раздувает основные таблицы, требует миграций при добавлении языков.
- **django-parler** — отдельные таблицы, но с магией на уровне модели. Отклонено: дополнительная зависимость, меньше контроля.
- **JSONField для переводов** — `translations = {"en": {...}, "ru": {...}}`. Отклонено: сложнее индексировать и валидировать.

**Обоснование:** Отдельные модели дают полный контроль, не требуют внешних зависимостей, легко расширяются, работают с Django admin из коробки.

### Decision 2: Список языков на уровне SurveyHeader

**Выбор:** Добавить поле `available_languages` в `SurveyHeader` как `JSONField` со списком кодов языков (например, `["en", "ru", "de"]`).

**Альтернативы:**
- Отдельная модель `SurveyLanguage` с M2M. Отклонено: избыточно для простого списка.
- Вычислять доступные языки из существующих переводов. Отклонено: администратор должен явно контролировать, какие языки показывать респондентам.

**Обоснование:** JSONField компактен, не требует дополнительных JOIN-ов, легко редактируется в admin.

### Decision 3: Выбранный язык хранится в SurveySession

**Выбор:** Добавить поле `language` в `SurveySession` (CharField, nullable).

**Альтернативы:**
- Хранить только в Django session. Отклонено: теряется при очистке сессии, нет связи с ответами.
- Отдельная таблица респондент-язык. Отклонено: избыточно.

**Обоснование:** Язык становится частью данных опроса, можно анализировать ответы в разрезе языков.

### Decision 4: Helper-методы для получения переведённого контента

**Выбор:** Добавить методы `get_translated_title(lang)`, `get_translated_name(lang)` в модели, которые возвращают перевод или оригинал.

**Альтернативы:**
- Property с thread-local для текущего языка. Отклонено: неявное поведение, сложнее тестировать.
- Manager с `.translated(lang)`. Отклонено: усложняет существующие запросы.

**Обоснование:** Явные методы просты, предсказуемы, легко используются в views и forms.

### Decision 5: Маршрут выбора языка `/surveys/<name>/language/`

**Выбор:** Добавить URL `/surveys/<survey_name>/language/` и view `survey_language_select`.

**Обоснование:** Соответствует существующей структуре URL, логически предшествует секциям.

### Decision 6: Middleware не используется, язык активируется во view

**Выбор:** Активировать язык Django (`translation.activate()`) непосредственно в `survey_language_select` view и сохранять в Django session.

**Альтернативы:**
- Middleware для автоматической активации. Отклонено: усложняет логику, не нужно для всех запросов.

**Обоснование:** Локальная активация проще, работает только для респондентов опросов.

### Decision 7: Переводы сериализуются inline в survey.json

**Выбор:** Добавить массив `translations` в каждый объект секции, вопроса и option choice в survey.json.

**Альтернативы:**
- Отдельный файл `translations.json`. Отклонено: усложняет структуру архива, требует синхронизации ID.
- Отдельные файлы по языкам (`survey_en.json`, `survey_ru.json`). Отклонено: дублирование структуры.

**Обоснование:** Inline-переводы сохраняют атомарность — каждый объект содержит все свои данные. Легко читать и редактировать вручную.

## Risks / Trade-offs

**[Risk] Переводы могут рассинхронизироваться с оригиналом**
→ Mitigation: Документировать workflow редактирования, добавить индикатор "перевод устарел" в будущем.

**[Risk] N+1 запросы при загрузке переводов**
→ Mitigation: Использовать `select_related` / `prefetch_related` в views.

**[Risk] Большое количество inline-форм в admin для опросов с множеством языков**
→ Mitigation: Начать с базового inline, при необходимости создать кастомный admin view.

**[Trade-off] Дублирование кода получения переводов в models**
→ Принято: Можно вынести в миксин, но для 3 моделей приемлемо.

## Migration Plan

1. Добавить новые модели переводов (миграция)
2. Добавить `available_languages` в `SurveyHeader` (миграция)
3. Добавить `language` в `SurveySession` (миграция)
4. Добавить helper-методы в модели
5. Создать view и шаблон выбора языка
6. Модифицировать `survey_header` view для редиректа на выбор языка
7. Модифицировать `survey_section` view для использования переводов
8. Модифицировать `SurveySectionAnswerForm` для использования переводов
9. Добавить inline-админки для переводов
10. Обновить шаблоны для отображения переведённого контента
11. Расширить `export_survey_to_zip` для экспорта переводов и `available_languages`
12. Расширить `import_survey_from_zip` для импорта переводов

**Rollback:** Удалить новые модели и поля через обратные миграции. Существующие опросы не затрагиваются. Экспорты без переводов остаются совместимыми.

## Open Questions

- Нужен ли флаг "перевод устарел" при изменении оригинала? (Отложено на будущее)
- Какой UI для массового импорта переводов? (Отложено, пока через admin)
