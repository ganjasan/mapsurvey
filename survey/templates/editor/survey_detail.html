{% extends "editor/editor_base.html" %}

{% block page_title %}{{ survey.name }}{% endblock %}

{% block navbar_content %}
<span class="survey-name">{{ survey.name }}</span>
<button class="btn btn-sm btn-outline-secondary"
        data-toggle="modal" data-target="#settingsModal"
        hx-get="{% url 'editor_survey_settings' survey.name %}"
        hx-target="#settingsModalBody"
        hx-swap="innerHTML">
    <i class="fas fa-cog"></i> Settings
</button>
{% endblock %}

{% block content %}
<div class="editor-container">
    <!-- Left Sidebar: Sections -->
    <aside class="editor-sidebar">
        <div class="sidebar-header">Sections</div>
        <ul class="section-list" id="sections-list">
            {% for section in sections %}
                {% include "editor/partials/section_list_item.html" with is_current=forloop.first %}
            {% endfor %}
        </ul>
        <div class="sidebar-footer">
            <button class="add-question-btn"
                    hx-post="{% url 'editor_section_create' survey.name %}"
                    hx-target="#sections-list"
                    hx-swap="beforeend"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                <i class="fas fa-plus"></i> New Section
            </button>
        </div>
    </aside>

    <!-- Center Panel: Section Detail + Questions -->
    <main class="editor-main" id="editor-main">
        {% if current_section %}
        <div id="section-content"
             hx-get="{% url 'editor_section_detail' survey.name current_section.id %}"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div style="text-align:center;padding:2rem;color:#9ca3af;">Loading...</div>
        </div>
        {% else %}
        <div style="text-align:center;padding:3rem;color:#9ca3af;">
            <i class="fas fa-layer-group" style="font-size:2rem;margin-bottom:1rem;display:block;"></i>
            <p>No sections yet. Create one to get started.</p>
        </div>
        {% endif %}
    </main>

    <!-- Right Panel: Live Preview -->
    <aside class="editor-preview">
        <div class="preview-header">Preview</div>
        {% if current_section %}
        <iframe class="preview-frame" id="preview-frame"
                src="{% url 'editor_section_preview' survey.name current_section.name %}">
        </iframe>
        {% else %}
        <div style="padding:2rem;text-align:center;color:#9ca3af;font-size:0.85rem;">
            Preview will appear here when you add a section.
        </div>
        {% endif %}
    </aside>
</div>

<!-- Settings Modal -->
<div class="modal fade editor-modal" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id="settingsModalBody">
                <div style="padding:2rem;text-align:center;color:#9ca3af;">Loading...</div>
            </div>
        </div>
    </div>
</div>

<!-- Question Form Modal -->
<div class="modal fade editor-modal" id="questionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id="questionModalBody">
            </div>
        </div>
    </div>
</div>

<!-- Map Picker Modal -->
<div class="modal fade editor-modal" id="mapPickerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div id="mapPickerModalBody">
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // SortableJS for sections
    var sectionsList = document.getElementById('sections-list');
    if (sectionsList) {
        Sortable.create(sectionsList, {
            animation: 150,
            handle: '.drag-handle',
            onEnd: function() {
                var ids = Array.from(sectionsList.children).map(function(el) {
                    return el.dataset.sectionId;
                });
                fetch('{% url "editor_sections_reorder" survey.name %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ section_ids: ids })
                });
            }
        });
    }

    // Section click â†’ load section detail
    document.addEventListener('click', function(e) {
        var item = e.target.closest('.section-item');
        if (!item || e.target.closest('.section-delete')) return;
        var sectionId = item.dataset.sectionId;
        var sectionName = item.dataset.sectionName;
        // Highlight active
        document.querySelectorAll('.section-item').forEach(function(el) { el.classList.remove('active'); });
        item.classList.add('active');
        // Load section detail via HTMX
        htmx.ajax('GET', '/editor/surveys/{{ survey.name }}/sections/' + sectionId + '/', {
            target: '#section-content',
            swap: 'innerHTML'
        });
        // Update preview
        var iframe = document.getElementById('preview-frame');
        if (iframe) {
            iframe.src = '/editor/surveys/{{ survey.name }}/preview/' + sectionName + '/';
        }
    });

    // Refresh preview after HTMX swaps (debounced)
    var previewTimeout;
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'settingsModalBody' ||
            evt.detail.target.id === 'questionModalBody' ||
            evt.detail.target.id === 'mapPickerModalBody') return;
        clearTimeout(previewTimeout);
        previewTimeout = setTimeout(function() {
            var iframe = document.getElementById('preview-frame');
            if (iframe && iframe.src) {
                iframe.src = iframe.src;
            }
        }, 500);
    });

    // After section delete, load first remaining section
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.xhr && evt.detail.xhr.status === 200 && evt.detail.target.closest && evt.detail.target.closest('.section-item')) {
            var first = document.querySelector('.section-item');
            if (first) first.click();
        }
    });

    // After settings saved, close modal
    document.body.addEventListener('settingsSaved', function() {
        $('#settingsModal').modal('hide');
    });

    // After map position saved, close modal
    document.body.addEventListener('mapPositionSaved', function() {
        $('#mapPickerModal').modal('hide');
    });

    // Init SortableJS on question list after HTMX loads section detail
    document.body.addEventListener('htmx:afterSettle', function(evt) {
        var qList = document.getElementById('questions-list');
        if (qList && !qList._sortable) {
            qList._sortable = Sortable.create(qList, {
                animation: 150,
                handle: '.drag-handle',
                onEnd: function() {
                    var ids = Array.from(qList.children).map(function(el) {
                        return el.dataset.questionId;
                    });
                    fetch('{% url "editor_questions_reorder" survey.name %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ question_ids: ids })
                    });
                }
            });
        }
    });
});
</script>
{% endblock %}
