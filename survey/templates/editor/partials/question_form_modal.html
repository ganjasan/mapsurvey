{% load static %}
<div class="modal-header">
    <h5 class="modal-title">
        {% if parent %}New Sub-question for "{{ parent.name }}"
        {% elif question %}Edit Question
        {% else %}New Question
        {% endif %}
    </h5>
    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
</div>
<form {% if question %}
        hx-post="{% url 'editor_question_edit' survey.name question.id %}"
      {% elif parent %}
        hx-post="{% url 'editor_subquestion_create' survey.name parent.id %}"
      {% else %}
        hx-post="{% url 'editor_question_create' survey.name section.id %}"
      {% endif %}
      hx-target="#questions-list"
      hx-swap="beforeend"
      hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
      enctype="multipart/form-data">
    {% csrf_token %}
    <div class="modal-body">
        {% for field in form %}
        <div class="form-group">
            {% if field.name == 'required' %}
                <div class="form-check">
                    {{ field }}
                    <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                </div>
            {% else %}
                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                {{ field }}
            {% endif %}
            {% if field.help_text %}<small class="form-text text-muted">{{ field.help_text }}</small>{% endif %}
            {% for error in field.errors %}<div class="text-danger" style="font-size:0.8rem;">{{ error }}</div>{% endfor %}
        </div>
        {% endfor %}

        <!-- Choices editor -->
        <div class="choices-editor" id="choices-editor" style="display:none;">
            <label style="font-weight:600;">Choices</label>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th style="width:80px;">Code</th>
                        <th>Name</th>
                        {% for lang in survey.available_languages %}
                        <th>{{ lang|upper }}</th>
                        {% endfor %}
                        <th style="width:40px;"></th>
                    </tr>
                </thead>
                <tbody id="choices-rows">
                </tbody>
            </table>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addChoiceRow()">
                <i class="fas fa-plus"></i> Add Choice
            </button>
        </div>
        <input type="hidden" name="choices_json" id="choices-json-input">

        {% if survey.available_languages %}
        <div class="translations-section">
            <p style="font-size:0.85rem;font-weight:600;color:#6b7280;margin-bottom:0.5rem;">Translations</p>
            {% for lang in survey.available_languages %}
            <fieldset style="margin-bottom:0.5rem;">
                <legend>{{ lang|upper }}</legend>
                <div class="form-group">
                    <label style="font-size:0.8rem;">Name ({{ lang }})</label>
                    <input type="text" name="translation_{{ lang }}_name" class="form-control form-control-sm"
                           value="{% if question %}{% for t in question.translations.all %}{% if t.language == lang %}{{ t.name|default:'' }}{% endif %}{% endfor %}{% endif %}">
                </div>
                <div class="form-group">
                    <label style="font-size:0.8rem;">Subtext ({{ lang }})</label>
                    <input type="text" name="translation_{{ lang }}_subtext" class="form-control form-control-sm"
                           value="{% if question %}{% for t in question.translations.all %}{% if t.language == lang %}{{ t.subtext|default:'' }}{% endif %}{% endfor %}{% endif %}">
                </div>
            </fieldset>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" onclick="serializeChoices()">Save</button>
    </div>
</form>

<script>
(function() {
    var languages = {{ survey.available_languages|safe|default:"[]" }};
    var choicesEditor = document.getElementById('choices-editor');
    var inputTypeSelect = document.querySelector('#questionModalBody select[name="input_type"]');
    var choiceTypes = ['choice', 'multichoice', 'range', 'rating'];

    function toggleChoicesEditor() {
        if (inputTypeSelect && choiceTypes.indexOf(inputTypeSelect.value) !== -1) {
            choicesEditor.style.display = 'block';
        } else {
            choicesEditor.style.display = 'none';
        }
    }

    if (inputTypeSelect) {
        inputTypeSelect.addEventListener('change', toggleChoicesEditor);
        toggleChoicesEditor();
    }

    // Populate existing choices when editing
    {% if question and question.choices %}
    var existingChoices = {{ question.choices|safe }};
    existingChoices.forEach(function(choice) {
        addChoiceRow(choice.code, choice.name);
    });
    {% endif %}

    window.addChoiceRow = function(code, name) {
        var tbody = document.getElementById('choices-rows');
        var row = document.createElement('tr');
        var codeVal = code !== undefined ? code : '';
        var nameVal = '';
        var langVals = {};

        if (typeof name === 'string') {
            nameVal = name;
        } else if (typeof name === 'object' && name !== null) {
            // Pick first language as default display
            nameVal = name[Object.keys(name)[0]] || '';
            langVals = name;
        }

        var cells = '<td><input type="number" class="form-control form-control-sm choice-code" value="' + codeVal + '"></td>';
        cells += '<td><input type="text" class="form-control form-control-sm choice-name-default" value="' + (nameVal || '').replace(/"/g, '&quot;') + '"></td>';

        languages.forEach(function(lang) {
            var v = langVals[lang] || '';
            cells += '<td><input type="text" class="form-control form-control-sm choice-name-' + lang + '" value="' + v.replace(/"/g, '&quot;') + '"></td>';
        });

        cells += '<td><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest(\'tr\').remove()">&times;</button></td>';
        row.innerHTML = cells;
        tbody.appendChild(row);
    };

    window.serializeChoices = function() {
        var rows = document.querySelectorAll('#choices-rows tr');
        var choices = [];
        rows.forEach(function(row) {
            var code = parseInt(row.querySelector('.choice-code').value);
            if (isNaN(code)) return;

            var nameDefault = row.querySelector('.choice-name-default').value.trim();
            var nameObj = {};
            var hasLang = false;

            languages.forEach(function(lang) {
                var inp = row.querySelector('.choice-name-' + lang);
                if (inp && inp.value.trim()) {
                    nameObj[lang] = inp.value.trim();
                    hasLang = true;
                }
            });

            // If no language-specific names, use simple string
            var name = hasLang ? nameObj : nameDefault;
            choices.push({ code: code, name: name });
        });

        document.getElementById('choices-json-input').value = choices.length > 0 ? JSON.stringify(choices) : '';
    };
})();
</script>
